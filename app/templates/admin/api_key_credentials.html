{% extends 'admin/base.html' %}

{% block title %}API Key Credentials - {{ api_key.name }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 mb-0">
                <i class="fas fa-key text-primary"></i> API Key Credentials
            </h1>
            <p class="text-muted">{{ api_key.name }} for {{ api_key.client.company_name or api_key.client.email }}</p>
        </div>
        <a href="{{ url_for('admin.client_api_keys', client_id=api_key.client_id) }}" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left"></i> Back to API Keys
        </a>
    </div>

    <!-- Security Warning -->
    <div class="alert alert-danger">
        <h5 class="alert-heading">
            <i class="fas fa-exclamation-triangle"></i> Security Warning
        </h5>
        <p class="mb-0">
            <strong>These credentials are shown only once!</strong> Make sure to copy and save them securely now. 
            Once you leave this page, you won't be able to retrieve them again.
        </p>
    </div>

    {% if credentials.api_key %}
    <!-- Credentials Display -->
    <div class="row mb-4">
        <!-- API Key -->
        <div class="col-md-6 mb-4">
            <div class="card border-primary shadow">
                <div class="card-header bg-primary text-white">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-key"></i> API Key
                    </h5>
                </div>
                <div class="card-body">
                    <label class="form-label"><strong>PAYCRYPT_API_KEY</strong></label>
                    <div class="input-group mb-3">
                        <input type="password" class="form-control font-monospace" 
                               id="apiKey" value="{{ credentials.api_key }}" readonly>
                        <button class="btn btn-outline-secondary" type="button" 
                                onclick="toggleVisibility('apiKey', 'eyeIcon1')">
                            <i class="fas fa-eye" id="eyeIcon1"></i>
                        </button>
                        <button class="btn btn-outline-primary" type="button" 
                                onclick="copyToClipboard('{{ credentials.api_key }}', 'API Key')">
                            <i class="fas fa-copy"></i>
                        </button>
                    </div>
                    <div class="alert alert-info mb-0">
                        <small>
                            <i class="fas fa-info-circle"></i>
                            Use this in the <code>Authorization</code> header: 
                            <code>Bearer {{ credentials.api_key[:12] }}...</code>
                        </small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Secret Key -->
        <div class="col-md-6 mb-4">
            <div class="card border-success shadow">
                <div class="card-header bg-success text-white">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-shield-alt"></i> Secret Key
                    </h5>
                </div>
                <div class="card-body">
                    <label class="form-label"><strong>PAYCRYPT_SECRET_KEY</strong></label>
                    <div class="input-group mb-3">
                        <input type="password" class="form-control font-monospace" 
                               id="secretKey" value="{{ credentials.secret_key }}" readonly>
                        <button class="btn btn-outline-secondary" type="button" 
                                onclick="toggleVisibility('secretKey', 'eyeIcon2')">
                            <i class="fas fa-eye" id="eyeIcon2"></i>
                        </button>
                        <button class="btn btn-outline-success" type="button" 
                                onclick="copyToClipboard('{{ credentials.secret_key }}', 'Secret Key')">
                            <i class="fas fa-copy"></i>
                        </button>
                    </div>
                    <div class="alert alert-info mb-0">
                        <small>
                            <i class="fas fa-info-circle"></i>
                            Use this for request signing and the <code>X-Secret-Key</code> header
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    {% if credentials.webhook_secret %}
    <!-- Webhook Secret -->
    <div class="card border-warning shadow mb-4">
        <div class="card-header bg-warning">
            <h5 class="card-title mb-0">
                <i class="fas fa-webhook"></i> Webhook Secret
            </h5>
        </div>
        <div class="card-body">
            <label class="form-label"><strong>PAYCRYPT_WEBHOOK_SECRET</strong></label>
            <div class="input-group mb-3">
                <input type="password" class="form-control font-monospace" 
                       id="webhookSecret" value="{{ credentials.webhook_secret }}" readonly>
                <button class="btn btn-outline-secondary" type="button" 
                        onclick="toggleVisibility('webhookSecret', 'eyeIcon3')">
                    <i class="fas fa-eye" id="eyeIcon3"></i>
                </button>
                <button class="btn btn-outline-warning" type="button" 
                        onclick="copyToClipboard('{{ credentials.webhook_secret }}', 'Webhook Secret')">
                    <i class="fas fa-copy"></i>
                </button>
            </div>
            <div class="alert alert-info mb-0">
                <small>
                    <i class="fas fa-info-circle"></i>
                    Use this to verify webhook signatures (HMAC-SHA256)
                </small>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- API Key Information -->
    <div class="card shadow mb-4">
        <div class="card-header">
            <h6 class="m-0 font-weight-bold text-primary">
                <i class="fas fa-info-circle"></i> API Key Information
            </h6>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <dl class="row">
                        <dt class="col-sm-4">Name:</dt>
                        <dd class="col-sm-8">{{ api_key.name }}</dd>
                        
                        <dt class="col-sm-4">Prefix:</dt>
                        <dd class="col-sm-8"><code>{{ api_key.key_prefix }}</code></dd>
                        
                        <dt class="col-sm-4">Client Type:</dt>
                        <dd class="col-sm-8">
                            {% if api_key.client_type == 'flat_rate' %}
                            <span class="badge bg-info">Flat Rate</span>
                            {% else %}
                            <span class="badge bg-secondary">Commission</span>
                            {% endif %}
                        </dd>
                        
                        <dt class="col-sm-4">Rate Limit:</dt>
                        <dd class="col-sm-8">{{ api_key.rate_limit }} requests/min</dd>
                    </dl>
                </div>
                <div class="col-md-6">
                    <dl class="row">
                        <dt class="col-sm-4">Client:</dt>
                        <dd class="col-sm-8">
                            <a href="{{ url_for('admin.view_client', client_id=api_key.client_id) }}">
                                {{ api_key.client.company_name or api_key.client.email }}
                            </a>
                        </dd>
                        
                        <dt class="col-sm-4">Created:</dt>
                        <dd class="col-sm-8">{{ api_key.created_at.strftime('%Y-%m-%d %H:%M') }}</dd>
                        
                        <dt class="col-sm-4">Expires:</dt>
                        <dd class="col-sm-8">
                            {% if api_key.expires_at %}
                            {{ api_key.expires_at.strftime('%Y-%m-%d') }}
                            {% else %}
                            <span class="text-muted">Never</span>
                            {% endif %}
                        </dd>
                        
                        <dt class="col-sm-4">Status:</dt>
                        <dd class="col-sm-8">
                            {% if api_key.is_active %}
                            <span class="badge bg-success">Active</span>
                            {% else %}
                            <span class="badge bg-danger">Inactive</span>
                            {% endif %}
                        </dd>
                    </dl>
                </div>
            </div>
        </div>
    </div>

    <!-- Integration Examples -->
    <div class="card shadow">
        <div class="card-header">
            <h6 class="m-0 font-weight-bold text-primary">
                <i class="fas fa-code"></i> Integration Examples
            </h6>
        </div>
        <div class="card-body">
            <!-- Python Example -->
            <h6 class="text-primary mt-3"><i class="fab fa-python"></i> Python</h6>
            <pre class="bg-dark text-light p-3 rounded"><code>import requests

headers = {
    'Authorization': 'Bearer {{ credentials.api_key[:12] }}...',
    'X-Secret-Key': '{{ credentials.secret_key[:12] }}...',
    'Content-Type': 'application/json'
}

data = {
    'amount': 100.00,
    'currency': 'USDT'
}

response = requests.post('{{ request.url_root }}api/v1/payments', 
                        json=data, 
                        headers=headers)
print(response.json())</code></pre>

            <!-- cURL Example -->
            <h6 class="text-primary mt-4"><i class="fas fa-terminal"></i> cURL</h6>
            <pre class="bg-dark text-light p-3 rounded"><code>curl -X POST {{ request.url_root }}api/v1/payments \
  -H "Authorization: Bearer {{ credentials.api_key[:12] }}..." \
  -H "X-Secret-Key: {{ credentials.secret_key[:12] }}..." \
  -H "Content-Type: application/json" \
  -d '{
    "amount": 100.00,
    "currency": "USDT"
  }'</code></pre>

            <!-- JavaScript Example -->
            <h6 class="text-primary mt-4"><i class="fab fa-js"></i> JavaScript (Node.js)</h6>
            <pre class="bg-dark text-light p-3 rounded"><code>const axios = require('axios');

const config = {
    headers: {
        'Authorization': 'Bearer {{ credentials.api_key[:12] }}...',
        'X-Secret-Key': '{{ credentials.secret_key[:12] }}...',
        'Content-Type': 'application/json'
    }
};

const data = {
    amount: 100.00,
    currency: 'USDT'
};

axios.post('{{ request.url_root }}api/v1/payments', data, config)
    .then(response => console.log(response.data))
    .catch(error => console.error(error));</code></pre>
        </div>
    </div>

    {% else %}
    <!-- No Credentials Available -->
    <div class="alert alert-warning">
        <h5 class="alert-heading">
            <i class="fas fa-exclamation-triangle"></i> Credentials Not Available
        </h5>
        <p class="mb-0">
            API key credentials are only displayed once at creation time. If you need to access this API key again, 
            you'll need to regenerate it, which will create new credentials.
        </p>
    </div>

    <div class="card shadow">
        <div class="card-body text-center py-5">
            <i class="fas fa-key fa-4x text-muted mb-3"></i>
            <p class="text-muted">The credentials for this API key are no longer available.</p>
            <form method="post" action="{{ url_for('admin.regenerate_api_key', key_id=api_key.id) }}"
                  onsubmit="return confirm('This will generate new credentials. The old credentials will stop working. Continue?')">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-sync"></i> Regenerate Credentials
                </button>
            </form>
        </div>
    </div>
    {% endif %}
</div>

<script>
function toggleVisibility(inputId, iconId) {
    const input = document.getElementById(inputId);
    const icon = document.getElementById(iconId);
    
    if (input.type === 'password') {
        input.type = 'text';
        icon.classList.remove('fa-eye');
        icon.classList.add('fa-eye-slash');
    } else {
        input.type = 'password';
        icon.classList.remove('fa-eye-slash');
        icon.classList.add('fa-eye');
    }
}

function copyToClipboard(text, label) {
    navigator.clipboard.writeText(text).then(() => {
        // Show success message
        const toast = document.createElement('div');
        toast.className = 'position-fixed bottom-0 end-0 p-3';
        toast.style.zIndex = '11';
        toast.innerHTML = `
            <div class="toast show" role="alert">
                <div class="toast-header bg-success text-white">
                    <i class="fas fa-check-circle me-2"></i>
                    <strong class="me-auto">Copied!</strong>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast"></button>
                </div>
                <div class="toast-body">
                    ${label} copied to clipboard
                </div>
            </div>
        `;
        document.body.appendChild(toast);
        
        setTimeout(() => {
            toast.remove();
        }, 3000);
    }).catch(err => {
        alert('Failed to copy: ' + err);
    });
}
</script>
{% endblock %}
